<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PortalDrive Test Control</title>
  <style>
    body { background:#111; color:#0f0; font-family:monospace; margin:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; align-items:center; }
    button { padding:10px 14px; font-size:16px; cursor:pointer; }
    button:disabled { opacity:.4; cursor:not-allowed; }
    #log { white-space:pre-wrap; background:#000; padding:10px; border:1px solid #0f0; height:320px; overflow:auto; }
    .hint { color:#7CFF7C; opacity:.9; }
  </style>
</head>

<body>
<h2>PortalDrive ‚Äì Test Control</h2>

<div class="row">
  <button id="btnConnect">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  <button id="btnStopAll" disabled>üõë STOP</button>
  <span class="hint">–î–µ—Ä–∂–∏ –∫–Ω–æ–ø–∫—É = –µ–¥–µ—Ç. –û—Ç–ø—É—Å—Ç–∏–ª = –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º stop —Å—Ä–∞–∑—É (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è watchdog).</span>
</div>

<div class="row">
  <button class="ctrl" data-cmd="forward_start" disabled>‚¨Ü –í–ø–µ—Ä—ë–¥</button>
  <button class="ctrl" data-cmd="back_start" disabled>‚¨á –ù–∞–∑–∞–¥</button>
  <button class="ctrl" data-cmd="left_start" disabled>‚¨Ö –õ–µ–≤–∞—è</button>
  <button class="ctrl" data-cmd="right_start" disabled>‚û° –ü—Ä–∞–≤–∞—è</button>
</div>

<pre id="log"></pre>

<!-- LiveKit UMD -->
<script src="https://unpkg.com/livekit-client@2/dist/livekit-client.umd.js"></script>

<script>
  // === –ù–ê–°–¢–†–û–ô–ö–ò ===
  const LIVEKIT_URL = "wss://portaldrivemain-l93pd6cc.livekit.cloud";
  const TOKEN_URL   = "https://token-ozqtgt3ylq-uc.a.run.app";

  const ROOM = "pd_unjYr2_tb01";
  const IDENTITY = "test_controller_" + Math.floor(Math.random() * 10000);

  // === UI/LOG ===
  const logEl = document.getElementById("log");
  const log = (t) => {
    logEl.textContent += t + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  };

  let room = null;
  let holdTimer = null;
  let connecting = false;
  let activeCmd = null;           // —á—Ç–æ —Å–µ–π—á–∞—Å "–¥–µ—Ä–∂–∏–º"
  let stopBurstTimer = null;      // –≤—Ç–æ—Ä–æ–π —Å—Ç–æ–ø –Ω–∞ –≤—Å—è–∫–∏–π

  function setControlsEnabled(enabled) {
    document.querySelectorAll(".ctrl").forEach(b => b.disabled = !enabled);
    document.getElementById("btnStopAll").disabled = !enabled;
  }

  // === TOKEN ===
  async function getToken() {
    // –í–ê–ñ–ù–û: —Ä–æ–ª—å controller, —á—Ç–æ–±—ã canPublish=true (DataChannel)
    const url = `${TOKEN_URL}?room=${encodeURIComponent(ROOM)}&identity=${encodeURIComponent(IDENTITY)}&role=controller`;
    const r = await fetch(url);

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")) {
      const j = await r.json();
      if (!j.token) throw new Error("token –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ JSON –æ—Ç–≤–µ—Ç–µ");
      return j.token;
    }

    const txt = (await r.text()).trim();
    if (txt.startsWith("{")) {
      try {
        const j = JSON.parse(txt);
        if (j.token) return j.token;
      } catch (_) {}
    }
    if (!txt) throw new Error("–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç token —Å–µ—Ä–≤–∏—Å–∞");
    return txt;
  }

  // === SEND: PLAIN STRING ===
  function publishCmd(cmd) {
    if (!room || !room.localParticipant) {
      log("‚ùå publishCmd: –Ω–µ—Ç room/localParticipant");
      return;
    }
    const payload = new TextEncoder().encode(cmd);
    try {
      room.localParticipant.publishData(payload, { reliable: true });
    } catch (e) {
      log("‚ùå publishData error: " + (e?.message || e));
    }
  }

  function stopNow(reason = "") {
    // –≥–∞—Å–∏–º –ø–æ–≤—Ç–æ—Ä—è–ª–∫—É
    if (holdTimer) clearInterval(holdTimer);
    holdTimer = null;
    activeCmd = null;

    // –≥–∞—Å–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π burst
    if (stopBurstTimer) clearTimeout(stopBurstTimer);
    stopBurstTimer = null;

    // –®–ª—ë–º —Å—Ç–æ–ø —Å—Ä–∞–∑—É + –¥—É–±–ª—å —á–µ—Ä–µ–∑ 100–º—Å (—É—Å—Ç–æ–π—á–∏–≤–µ–µ –ø—Ä–∏ –¥—Ä–æ–∂–∏/–ø–æ—Ç–µ—Ä–µ –ø–∞–∫–µ—Ç–∞)
    publishCmd("stop");
    log("SEND: stop" + (reason ? ` (${reason})` : ""));

    stopBurstTimer = setTimeout(() => {
      publishCmd("stop");
      log("SEND: stop (burst2)");
    }, 100);
  }

  function startHold(cmd) {
    if (!room) { log("‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ"); return; }

    // –µ—Å–ª–∏ –¥–µ—Ä–∂–∏–º –¥—Ä—É–≥–æ–µ ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å—Ç–æ–ø–Ω–µ–º
    if (activeCmd && activeCmd !== cmd) stopNow("switch");

    activeCmd = cmd;

    if (holdTimer) clearInterval(holdTimer);
    if (stopBurstTimer) { clearTimeout(stopBurstTimer); stopBurstTimer = null; }

    const send = () => {
      publishCmd(cmd);
      log("SEND: " + cmd);
    };

    // —Å—Ä–∞–∑—É
    send();
    // –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º, –ø–æ–∫–∞ –¥–µ—Ä–∂–∏–º
    holdTimer = setInterval(send, 120);
  }

  function stopHold() {
    // –ö–õ–Æ–ß: –Ω–µ –º–æ–ª—á–∏–º ‚Äî –∞ —Å—Ç–æ–ø–∞–µ–º —Å—Ä–∞–∑—É
    stopNow("release");
  }

  async function connectLK() {
    if (connecting) return;
    connecting = true;

    if (typeof LivekitClient === "undefined") {
      log("‚ùå LivekitClient –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç / CDN.");
      connecting = false;
      return;
    }

    setControlsEnabled(false);
    log("–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞...");

    let token = "";
    try {
      token = await getToken();
    } catch (e) {
      log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: " + (e?.message || e));
      connecting = false;
      return;
    }

    log("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ LiveKit –∫–∞–∫ " + IDENTITY + " ...");
    room = new LivekitClient.Room({ adaptiveStream: true, dynacast: true });

    room.on("disconnected", () => {
      log("‚ö†Ô∏è disconnected");
      setControlsEnabled(false);
      stopNow("disconnected");
    });

    try {
      await room.connect(LIVEKIT_URL, token);
      log("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ: " + ROOM);
      setControlsEnabled(true);
    } catch (e) {
      log("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + (e?.message || e));
      room = null;
      setControlsEnabled(false);
    } finally {
      connecting = false;
    }
  }

  // === UI EVENTS ===
  document.getElementById("btnConnect").addEventListener("click", connectLK);
  document.getElementById("btnStopAll").addEventListener("click", () => stopNow("button"));

  // pointer events = –ª—É—á—à–∏–π –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–º—ã—à—å/—Ç–∞—á/—Å—Ç–∏–ª—É—Å)
  document.querySelectorAll(".ctrl").forEach(btn => {
    const cmd = btn.dataset.cmd;

    btn.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      btn.setPointerCapture?.(e.pointerId);
      startHold(cmd);
    });

    btn.addEventListener("pointerup", (e) => {
      e.preventDefault();
      stopHold();
    });

    btn.addEventListener("pointercancel", (e) => {
      e.preventDefault();
      stopHold();
    });

    btn.addEventListener("pointerleave", (e) => {
      // –µ—Å–ª–∏ –ø–∞–ª–µ—Ü/–º—ã—à—å —É—à–ª–∏ ‚Äî —Ç–æ–∂–µ —Å—Ç–æ–ø
      stopHold();
    });
  });

  // –ì–ª–æ–±–∞–ª—å–Ω–æ: –æ—Ç–ø—É—Å—Ç–∏–ª –≥–¥–µ —É–≥–æ–¥–Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî —Å—Ç–æ–ø
  window.addEventListener("pointerup", stopHold);
  window.addEventListener("pointercancel", stopHold);
  window.addEventListener("blur", () => stopNow("blur"));
</script>
</body>
</html>
